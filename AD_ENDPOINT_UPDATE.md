# تحديث Endpoint: create_clinic_ad

## التاريخ: 29/10/2025

## التغييرات المطبقة:

### 1. Request Body (لم يتغير - يقبل نفس الحقول)
```json
{
  "request_date": "22/10/2025",
  "clinic_name": "عيادة الأسنان",
  "ad_subtitle": "عيادة متخصصة في كل شيء",
  "ad_description": "عرض خاص",
  "ad_phonenumber": "٠١٠١٢٣٤٥٦٧٨",
  "ad_state": "القاهرة",
  "ad_discount": "٢٠",
  "ad_price": "١٠٠",
  "ad_address": "الحي الاول عمارة يعقوبيان",
  "team_message": "رسالة الفريق",
  "ad_image_url": "https://...",
  "clinic_id": "7",
  "ad_status": "active"
}
```

### 2. Response الجديد (مبسّط)
```json
{
  "ad_ID": "7_a1b2c3d4_1730203859",
  "ad_image": "https://...",
  "ad_state": "القاهرة",
  "clinic_id": 7,
  "ad_status": false,
  "expierd_date": "28/11/2025"
}
```

**ملاحظات على Response:**
- ✅ `ad_image` بدلاً من `ad_image_url`
- ✅ `expierd_date` بدلاً من `expired_date` (كما طلبت)
- ✅ `ad_status` دائماً `false` عند الإنشاء
- ✅ فقط 6 حقول في الاستجابة (مبسط)

### 3. قواعد التحقق من الصورة الجديدة

#### أبعاد الصورة (إلزامي):
- **العرض:** 500 بكسل بالضبط
- **الارتفاع:** 250 بكسل بالضبط
- ❌ إذا كانت الأبعاد مختلفة → رفض

**مثال رسالة الخطأ:**
```json
{
  "error": {
    "code": "invalid_image",
    "message": "أبعاد الصورة يجب أن تكون 500x250 بالضبط. الأبعاد الحالية: 600x300"
  }
}
```

#### حجم الصورة (إلزامي):
- **الحد الأقصى:** 2 ميجابايت (2048 كيلوبايت)
- ❌ إذا كان الحجم أكبر → رفض

**مثال رسالة الخطأ:**
```json
{
  "error": {
    "code": "invalid_image",
    "message": "حجم الصورة يجب أن يكون أقل من 2 ميجابايت"
  }
}
```

### 4. منطق ad_status (الحالة الذكية)

#### عند الإنشاء:
- المستخدم يرسل `"ad_status": "active"` أو `"ad_status": "false"`
- **النظام يحفظ دائماً:** `false`
- السبب: الإعلان غير مفعّل حتى يتم تفعيله يدوياً

#### عند التفعيل (سيتم لاحقاً):
- عندما يتم تفعيل الإعلان → `ad_status = true`
- يُسجل `activated_at` (وقت التفعيل)

#### بعد 24 ساعة (تلقائي):
- النظام يفحص الإعلانات كل فترة
- إذا مرّ 24 ساعة من `activated_at` → `ad_status = false`

### 5. التحديثات التقنية

#### ملفات معدلة:
- ✅ `app/ads.py` - إضافة دالة التحقق من الصورة
- ✅ `requirements.txt` - إضافة `Pillow>=10.0.0`

#### المكتبات الجديدة:
```python
from PIL import Image
import requests
import io
```

#### الدالة الرئيسية:
```python
def _validate_image_dimensions_and_size(image_url: str) -> tuple[bool, str | None]:
    """
    يتحقق من:
    1. إمكانية تحميل الصورة من URL
    2. حجم الصورة أقل من 2MB
    3. أبعاد الصورة بالضبط 500x250
    """
```

### 6. رسائل الخطأ المحتملة

| الخطأ | الرسالة |
|------|---------|
| أبعاد خاطئة | `أبعاد الصورة يجب أن تكون 500x250 بالضبط. الأبعاد الحالية: {width}x{height}` |
| حجم كبير | `حجم الصورة يجب أن يكون أقل من 2 ميجابايت` |
| رابط فاشل | `فشل الاتصال بالصورة: {error}` |
| timeout | `انتهت مهلة الاتصال بالصورة` |
| حقل مفقود | `{field} مطلوب` |

### 7. اختبار الـ Endpoint

#### باستخدام curl:
```bash
curl -X POST https://tabeby-api.onrender.com/api/create_clinic_ad \
  -H "Doctor-Secret: your-secret" \
  -H "Content-Type: application/json" \
  -d '{
    "clinic_name": "عيادة الأسنان",
    "ad_state": "القاهرة",
    "ad_image_url": "https://via.placeholder.com/500x250.png",
    "clinic_id": "7",
    "ad_status": "false"
  }'
```

#### صورة اختبار صالحة (500x250):
```
https://via.placeholder.com/500x250.png
```

#### صورة اختبار غير صالحة (600x300):
```
https://via.placeholder.com/600x300.png
```

### 8. التوافق مع الكود القديم

- ✅ جميع الحقول القديمة مدعومة
- ✅ الأرقام العربية يتم تحويلها تلقائياً
- ✅ البيانات الكاملة محفوظة في `payload_json`
- ✅ فقط الـ Response تغيّر (مبسط)

---

## خطوات التنفيذ التالية:

1. ✅ تعديل الكود
2. ✅ إضافة Pillow
3. ⏳ Commit & Push
4. ⏳ Deploy على Render
5. ⏳ اختبار على Production

## ملاحظات مهمة:

- ⚠️ التحقق من الصورة يحتاج وصول للإنترنت (يحمل الصورة فعلياً)
- ⚠️ قد يستغرق 5-10 ثواني للصور الكبيرة
- ⚠️ إذا كان الرابط غير صالح → فشل فوري
- ✅ النظام يحمّل الصورة stream (لا يحمّل كل الذاكرة)
