# نظام الأرشفة التلقائية للحجوزات

## نظرة عامة

تم تطبيق نظام أرشفة تلقائية للحجوزات القديمة يعمل يوميًا في الساعة **12:00 ليلاً** بتوقيت العراق.

## الوظائف الرئيسية

### 1. أرشفة الحجوزات العادية
- **التوقيت**: 12:00 ص (منتصف الليل) بتوقيت العراق
- **الوظيفة**: `archive_old_bookings()`
- **الخطوات**:
  1. جلب جميع الحجوزات القديمة (قبل اليوم الحالي)
  2. حفظ كل يوم في جدول `booking_archives`
  3. حذف الأيام القديمة من `booking_tables`

### 2. أرشفة الحجوزات الذهبية
- **التوقيت**: 12:05 ص بتوقيت العراق (بفارق 5 دقائق)
- **الوظيفة**: `archive_old_golden_bookings()`
- **الخطوات**:
  1. جلب جميع الحجوزات الذهبية القديمة (قبل اليوم الحالي)
  2. حفظ كل يوم في جدول `golden_booking_archives`
  3. حذف الأيام القديمة من `golden_booking_tables`

## البيانات المحفوظة في الأرشيف

كل سجل أرشيف يحتوي على:
- `clinic_id`: معرف العيادة
- `table_date`: تاريخ اليوم (YYYY-MM-DD)
- `capacity_total`: السعة الكلية
- `capacity_served`: عدد المرضى المخدومين
- `capacity_cancelled`: عدد الحجوزات الملغية
- `patients_json`: بيانات المرضى بصيغة JSON
- `created_at`: تاريخ الإنشاء
- `updated_at`: تاريخ آخر تحديث

## الحماية من التكرار

- يتحقق النظام من عدم وجود أرشيف مسبق لنفس اليوم قبل الإنشاء
- يمنع تكرار البيانات في جدول الأرشيف

## التوقيت

### توقيت العراق (UTC+3)
- الساعة 12:00 ص في العراق = 21:00 (9 مساءً) بتوقيت UTC

### المهام المجدولة
1. **أرشفة الحجوزات العادية**: 21:00 UTC (00:00 Iraq)
2. **أرشفة الحجوزات الذهبية**: 21:05 UTC (00:05 Iraq)

## كيفية التشغيل

### تشغيل تلقائي
يتم تشغيل المجدول تلقائيًا عند بدء التطبيق في `startup_event` في `main.py`.

### اختبار يدوي
يمكنك اختبار النظام يدويًا:

```bash
python test_archive_scheduler.py
```

### تشغيل يدوي
```python
from app.scheduler import archive_old_bookings, archive_old_golden_bookings

# أرشفة الحجوزات العادية
archive_old_bookings()

# أرشفة الحجوزات الذهبية
archive_old_golden_bookings()
```

## السجلات (Logs)

يقوم النظام بتسجيل جميع العمليات:
- بدء عملية الأرشفة
- عدد الأيام المؤرشفة
- أي أخطاء قد تحدث

مثال:
```
2025-11-14 21:00:00 - بدء عملية أرشفة الحجوزات العادية القديمة
2025-11-14 21:00:00 - التاريخ الحالي (العراق): 2025-11-14
2025-11-14 21:00:05 - تم أرشفة: عيادة 4, تاريخ 2025-11-10, مرضى: 1
2025-11-14 21:00:05 - تم أرشفة: عيادة 4, تاريخ 2025-11-11, مرضى: 4
2025-11-14 21:00:05 - اكتملت عملية الأرشفة: 5 يوم تم أرشفته، 5 يوم تم حذفه
```

## الملفات المعدلة

1. **app/scheduler.py** (جديد)
   - يحتوي على دوال الأرشفة وإعداد المجدول

2. **app/main.py**
   - إضافة استيراد المجدول
   - بدء المجدول في `startup_event`
   - إيقاف المجدول في `shutdown_event`

3. **requirements.txt**
   - إضافة `APScheduler>=3.10.4`

4. **test_archive_scheduler.py** (جديد)
   - ملف اختبار للنظام

## المتطلبات

```
APScheduler>=3.10.4
```

تثبيت المتطلبات:
```bash
pip install -r requirements.txt
```

## ملاحظات مهمة

1. ✅ **الأمان**: يتحقق النظام من عدم تكرار الأرشفة لنفس اليوم
2. ✅ **الموثوقية**: يستخدم transactions لضمان سلامة البيانات
3. ✅ **السجلات**: جميع العمليات مسجلة بالتفصيل
4. ✅ **الأداء**: يعمل في الخلفية دون تأثير على المستخدمين
5. ✅ **التوقيت الدقيق**: يستخدم توقيت العراق الصحيح (UTC+3)

## استعلامات مفيدة

### عرض الأرشيفات لعيادة معينة
```python
from app.database import SessionLocal
from app import models

db = SessionLocal()
archives = db.query(models.BookingArchive).filter(
    models.BookingArchive.clinic_id == 4
).order_by(models.BookingArchive.table_date.desc()).all()

for arch in archives:
    print(f"{arch.table_date}: {arch.capacity_total} مريض")
```

### حساب إجمالي المرضى المخدومين
```python
from sqlalchemy import func

total_served = db.query(
    func.sum(models.BookingArchive.capacity_served)
).filter(
    models.BookingArchive.clinic_id == 4
).scalar()

print(f"إجمالي المرضى المخدومين: {total_served}")
```

## الدعم

في حالة وجود أي مشاكل، راجع السجلات (logs) أو تواصل مع فريق التطوير.
